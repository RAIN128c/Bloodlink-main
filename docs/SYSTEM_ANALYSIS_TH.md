# การวิเคราะห์ระบบและแผนภาพ ER (System Analysis & ER Diagram)

## 1. ภาพรวมของระบบ (System Overview)
**Bloodlink** เป็นเว็บแอปพลิเคชันจัดการกระบวนการตรวจเลือดในคลินิกหรือโรงพยาบาล ครอบคลุมตั้งแต่การลงทะเบียนผู้ป่วย, การติดตามสถานะคิว, การบันทึกผลแล็บ, การตรวจสอบผลโดยแพทย์, ไปจนถึงการส่งมอบผลและการดูประวัติย้อนหลัง

## 2. เทคโนโลยีที่ใช้ (Technology Stack)
*   **Frontend:** Next.js (App Router)
*   **Language:** TypeScript
*   **Styling:** Tailwind CSS + Shadcn UI
*   **Backend & Database:** Supabase (PostgreSQL)
*   **Authentication:** NextAuth.js + Supabase Auth
*   **Real-time:** Supabase Realtime (Websockets)

## 3. ฟีเจอร์หลัก (Core Features)
1.  **ระบบจัดการผู้ป่วย:** ลงทะเบียน, ติดตามสถานะ (รอตรวจ/กำลังตรวจ/เสร็จสิ้น), ประวัติการรักษา
2.  **ระบบข้อมูลห้องปฏิบัติการ (LIS):** บันทึกผลแล็บ (CBC ฯลฯ), ตรวจสอบค่าผิดปกติอัตโนมัติ (Validate), กราฟแนวโน้ม
3.  **ระบบจัดการสิทธิ์ (RBAC):** แยกสิทธิ์ชัดเจนระหว่าง Admin, Doctor (แพทย์), MedTech (เทคนิคการแพทย์)
4.  **ระบบนัดหมาย:** จองวันนัดและติดตามตารางนัด
5.  **การแจ้งเตือน:** แจ้งเตือนเมื่อผลแล็บออกหรือต้องรอการอนุมัติ

## 4. โครงสร้างฐานข้อมูล (Database Schema)
ระบบใช้ฐานข้อมูลเชิงสัมพันธ์ (Relational Database) โดยมีตารางหลักดังนี้:
*   **USERS:** เก็บข้อมูลเจ้าหน้าที่และแพทย์
*   **PATIENTS:** เก็บข้อมูลเวชระเบียนผู้ป่วย (HN, ชื่อ, อายุ)
*   **LAB_RESULTS:** เก็บผลเลือดรายครั้ง (WBC, RBC, Platelet, ฯลฯ)
*   **LAB_REFERENCE_RANGES:** เก็บค่าอ้างอิงปกติ (Min/Max) สำหรับตรวจสอบความผิดปกติ

## 5. โครงสร้างและการทำงานของโค้ด (Code Structure)

### 5.1 ส่วนจัดการข้อมูล (`src/lib`)
*   **`src/lib/supabase.ts`**: ตัวกลางเชื่อมต่อฐานข้อมูล
*   **`src/lib/permissions.ts`**: ระบบความปลอดภัย ตรวจสอบสิทธิ์การเข้าถึง (Role-Based)
*   **`src/lib/services/`**: โฟลเดอร์เก็บฟังก์ชันดึง/บันทึกข้อมูล (PatientService, LabService)

### 5.2 ส่วนหน้าจอผู้ใช้งาน (`src/app`)
*   **หน้าล็อกอิน:** `src/app/(auth)/login`
*   **ส่วนผู้ดูแล:** `src/app/admin` (กำหนดค่าแล็บ, จัดการหมอ)
*   **หน้าตรวจเลือด:** `src/app/results/[hn]/page.tsx` คือหัวใจหลัก ใช้สำหรับกรอกผลแล็บและแสดงการแจ้งเตือนค่าวิกฤต (Critical Values)

## 6. ความปลอดภัย (Security)
1.  **การยืนยันตัวตน:** ใช้ระบบ Session ที่ปลอดภัย ไม่เก็บรหัสผ่านเป็นข้อความปกติ
2.  **ลำดับชั้นสิทธิ์:** แพทย์เท่านั้นที่อนุมัติผลได้, แอดมินเท่านั้นที่แก้ค่าแล็บได้
3.  **ความปลอดภัยระดับข้อมูล (RLS):** ฐานข้อมูลป้องกันการดึงข้อมูลข้ามสิทธิ์โดยอัตโนมัติ

## 7. ประเด็นสำคัญเชิงเทคนิค
*   **ทำไมเก็บผลเป็น Text?** เพื่อรองรับค่าพิเศษ เช่น `<0.1` หรือ `Not Detected`
*   **ทำไมใช้ UUID?** เพื่อป้องกันการเดาเลข ID ผู้ป่วย (Sequential Guessing Attack)
