<!-- Patient Info Card -->
<div class="patient-info-card">
    <div class="card-header-row">
        <span class="check-date">ตรวจเมื่อวันที่ <%= bloodTest ? (bloodTest.timestamp ?
                bloodTest.timestamp.split(' ')[0] : ' -') : (patient.timestamp ? patient.timestamp.split(' ')[0] : ' -')
                %></span>
        <button class="cart-icon-btn" id="status-icon-btn" style="cursor: pointer;">
            <% const processIconMap={ 'นัดหมาย' : 'calendar' , 'เจาะเลือด' : 'message' , 'กำลังจัดส่ง' : 'cart'
                , 'กำลังตรวจ' : 'eye' , 'เสร็จสิ้น' : 'check' }; const currentIcon=processIconMap[patient.process]
                || 'cart' ; %>
                <% if (currentIcon==='calendar' ) { %>
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
                        <line x1="16" y1="2" x2="16" y2="6"></line>
                        <line x1="8" y1="2" x2="8" y2="6"></line>
                        <line x1="3" y1="10" x2="21" y2="10"></line>
                    </svg>
                    <% } else if (currentIcon==='message' ) { %>
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                            stroke-width="2">
                            <path
                                d="M21 11.5a8.38 8.38 0 0 1-.9 3.8 8.5 8.5 0 0 1-7.6 4.7 8.38 8.38 0 0 1-3.8-.9L3 21l1.9-5.7a8.38 8.38 0 0 1-.9-3.8 8.5 8.5 0 0 1 4.7-7.6 8.38 8.38 0 0 1 3.8-.9h.5a8.48 8.48 0 0 1 8 8v.5z">
                            </path>
                        </svg>
                        <% } else if (currentIcon==='eye' ) { %>
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                stroke-width="2">
                                <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z">
                                </path>
                                <circle cx="12" cy="12" r="3"></circle>
                            </svg>
                            <% } else if (currentIcon==='check' ) { %>
                                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                    stroke-width="2">
                                    <polyline points="20 6 9 17 4 12"></polyline>
                                </svg>
                                <% } else { %>
                                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                        stroke-width="2">
                                        <circle cx="9" cy="21" r="1"></circle>
                                        <circle cx="20" cy="21" r="1"></circle>
                                        <path d="M1 1h4l2.68 13.39a2 2 0 0 0 2 1.61h9.72a2 2 0 0 0 2-1.61L23 6H6">
                                        </path>
                                    </svg>
                                    <% } %>
        </button>
    </div>

    <div class="patient-info-content">
        <div class="profile-section">
            <div class="profile-image-large">
                <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                    <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
                    <circle cx="12" cy="7" r="4"></circle>
                </svg>
            </div>
            <h2 class="patient-name-large">
                <%= patient.name %>
                    <%= patient.surname %>
            </h2>
            <div class="patient-id-row">
                <% String(patient.hn).split('').forEach(digit=> { %>
                    <span>
                        <%= digit %>
                    </span>
                    <% }); %>
            </div>
            <% if (canEditPatientInfo) { %>
                <button class="edit-info-btn" id="edit-toggle-btn">แก้ไขข้อมูล</button>
                <% } %>
        </div>

        <div class="info-divider"></div>

        <div class="details-section">
            <div class="info-grid">
                <div class="info-item">
                    <label>เพศ</label>
                    <span class="value" id="gender-display">
                        <%= patient.gender %>
                    </span>
                    <div class="edit-input-group" id="gender-input" style="display: none;">
                        <label class="radio-inline"><input type="radio" name="gender" value="ชาย"
                                <%=patient.gender==='ชาย' ? 'checked' : '' %>>
                            ชาย</label>
                        <label class="radio-inline"><input type="radio" name="gender" value="หญิง"
                                <%=patient.gender==='หญิง' ? 'checked' : '' %>>
                            หญิง</label>
                        <label class="radio-inline"><input type="radio" name="gender" value="กำกวม"> กำกวม</label>
                    </div>
                </div>
                <div class="info-item">
                    <label>อายุ</label>
                    <span class="value" id="age-display">
                        <%= patient.age %> ปี
                    </span>
                    <div class="edit-input-group" id="age-input" style="display: none;">
                        <input type="number" class="edit-input" id="age-val" value="<%= patient.age %>"
                            style="width: 60px;"> ปี
                    </div>
                </div>
                <div class="info-item">
                    <label>หมู่เลือด</label>
                    <span class="value" id="blood-display">
                        <%= patient.bloodType %>
                    </span>
                    <div class="edit-input-group" id="blood-input" style="display: none;">
                        <label class="radio-inline"><input type="radio" name="blood" value="A"> A</label>
                        <label class="radio-inline"><input type="radio" name="blood" value="B"> B</label>
                        <label class="radio-inline"><input type="radio" name="blood" value="AB" checked> AB</label>
                        <label class="radio-inline"><input type="radio" name="blood" value="O"> O</label>
                    </div>
                </div>
                <div class="info-item">
                    <label>สถานะ</label>
                    <span class="value status-text" id="status-display">ใช้งาน</span>
                    <div class="edit-input-group" id="status-input" style="display: none;">
                        <label class="radio-inline"><input type="radio" name="active_status" value="ใช้งาน" checked>
                            ใช้งาน</label>
                        <label class="radio-inline"><input type="radio" name="active_status" value="ไม่ใช้งาน">
                            ไม่ใช้งาน</label>
                    </div>
                </div>
                <div class="info-item">
                    <label>โรคประจำตัว</label>
                    <div id="disease-display" class="tag-display">
                        <!-- Tags will be injected here -->
                    </div>
                    <div class="edit-input-group" id="disease-input" style="display: none;">
                        <div id="disease-tags-edit" class="tag-container"></div>
                        <input type="text" class="edit-input" id="disease-text-input"
                            placeholder="พิมพ์ชื่อโรคแล้วกด Enter">
                    </div>
                </div>
                <div class="info-item">
                    <label>อาการแพ้</label>
                    <span class="value" id="allergy-display">
                        <%= patient.allergies %>
                    </span>
                    <input type="text" class="edit-input" id="allergy-input" value="<%= patient.allergies %>"
                        style="display: none;">
                </div>
                <div class="info-item">
                    <label>วันที่ลงทะเบียน</label>
                    <span class="value">
                        <%= patient.timestamp ? patient.timestamp.split(' ')[0] : ' -' %>
                    </span>
                </div>
                <div class="info-item" id="ncd-item" style="display: none;">
                    <label>NCD</label>
                    <span class="value" id="ncd-display">-</span>
                    <div class="edit-input-group" id="ncd-input" style="display: none;">
                        <input type="text" class="edit-input" id="ncd-text-input" placeholder="รหัส NCD (เช่น 001)">
                    </div>
                </div>
                <div class="info-item" style="display: flex; align-items: flex-end;">
                    <button id="save-info-btn" class="save-btn" style="display: none;">บันทึก</button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- History Section -->
<div class="history-section">
    <div class="history-card-container">
        <h2 class="section-title">ประวัติการตรวจเลือด</h2>
        <% if (patient.latestReceipt || bloodTest) { %>
            <div class="history-item-card">
                <div class="history-item-content">
                    <div class="history-date">ตรวจเมื่อวันที่ <%= bloodTest ? (bloodTest.timestamp ?
                            bloodTest.timestamp.split(' ')[0] : ' -') : (patient.timestamp || '-' ) %>
                    </div>
                    <% if (patient.latestReceipt) { %>
                        <div class="history-detail-text" style="white-space: pre-line;">
                            <%= patient.latestReceipt %>
                        </div>
                        <% } %>
                </div>
            </div>
            <% } else { %>
                <div class="history-item-card">
                    <div class="history-item-content">
                        <div class="history-date" style="color: #9ca3af;">
                            ยังไม่มีประวัติการตรวจเลือด</div>
                    </div>
                </div>
                <% } %>
    </div>
</div>

<!-- Bottom Timeline & Action -->
<div class="bottom-action-area">
    <div class="timeline-wrapper">
        <% if (canEdit) { %>
            <div class="timeline-label" id="update-status-btn" style="cursor: pointer;">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7">
                    </path>
                    <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z">
                    </path>
                </svg>
                อัปเดตสถานะ
            </div>
            <% } %>
                <div class="timeline-steps">
                    <% const statusOrder=['นัดหมาย', 'เจาะเลือด' , 'กำลังจัดส่ง' , 'กำลังตรวจ' , 'เสร็จสิ้น' ]; const
                        currentStep=statusOrder.indexOf(patient.process); %>
                        <div class="step <%= currentStep >= 0 ? (currentStep === 0 ? 'active' : 'completed') : '' %>">
                            <div class="step-icon">
                                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                    stroke-width="2">
                                    <rect x="3" y="4" width="18" height="18" rx="2" ry="2">
                                    </rect>
                                    <line x1="16" y1="2" x2="16" y2="6"></line>
                                    <line x1="8" y1="2" x2="8" y2="6"></line>
                                    <line x1="3" y1="10" x2="21" y2="10"></line>
                                </svg>
                            </div>
                        </div>
                        <div class="connector <%= currentStep >= 1 ? 'completed' : '' %>">
                        </div>
                        <div class="step <%= currentStep >= 1 ? (currentStep === 1 ? 'active' : 'completed') : '' %>">
                            <div class="step-icon">
                                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                    stroke-width="2">
                                    <path
                                        d="M21 11.5a8.38 8.38 0 0 1-.9 3.8 8.5 8.5 0 0 1-7.6 4.7 8.38 8.38 0 0 1-3.8-.9L3 21l1.9-5.7a8.38 8.38 0 0 1-.9-3.8 8.5 8.5 0 0 1 4.7-7.6 8.38 8.38 0 0 1 3.8-.9h.5a8.48 8.48 0 0 1 8 8v.5z">
                                    </path>
                                </svg>
                            </div>
                        </div>
                        <div class="connector <%= currentStep >= 2 ? 'completed' : '' %>">
                        </div>
                        <div class="step <%= currentStep >= 2 ? (currentStep === 2 ? 'active' : 'completed') : '' %>">
                            <div class="step-icon">
                                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                    stroke-width="2">
                                    <circle cx="9" cy="21" r="1"></circle>
                                    <circle cx="20" cy="21" r="1"></circle>
                                    <path d="M1 1h4l2.68 13.39a2 2 0 0 0 2 1.61h9.72a2 2 0 0 0 2-1.61L23 6H6">
                                    </path>
                                </svg>
                            </div>
                        </div>
                        <div class="connector <%= currentStep >= 3 ? 'completed' : '' %>">
                        </div>
                        <div class="step <%= currentStep >= 3 ? (currentStep === 3 ? 'active' : 'completed') : '' %>">
                            <div class="step-icon">
                                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                    stroke-width="2">
                                    <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z">
                                    </path>
                                    <circle cx="12" cy="12" r="3"></circle>
                                </svg>
                            </div>
                        </div>
                        <div class="connector <%= currentStep >= 4 ? 'completed' : '' %>">
                        </div>
                        <div class="step <%= currentStep >= 4 ? 'active' : '' %>">
                            <div class="step-icon">
                                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                    stroke-width="2">
                                    <polyline points="20 6 9 17 4 12"></polyline>
                                </svg>
                            </div>
                        </div>
                </div>
    </div>

    <div class="action-card">
        <a href="/patient-detail?hn=<%= patient.hn %>" class="check-result-btn"
            style="text-decoration: none;">เช็คผลตรวจ</a>
        <span class="duration-text">
            <% if (typeof daysSinceTest !=='undefined' && daysSinceTest !==null) { %>
                นับตั้งแต่วันตรวจ <%= daysSinceTest %> วัน
                    <% } else { %>
                        ยังไม่มีข้อมูลการตรวจ
                        <% } %>
        </span>
    </div>
</div>

<!-- Disease List Modal -->
<div id="disease-modal" class="modal-overlay" style="display: none;">
    <div class="modal-content">
        <div class="modal-header">
            <h2>โรคประจำตัวทั้งหมด</h2>
        </div>
        <div class="modal-body">
            <div id="disease-list-modal-content" class="tag-container" style="justify-content: flex-start;">
                <!-- Full list of diseases will be injected here -->
            </div>
        </div>
        <div class="modal-footer">
            <button id="close-disease-modal-btn" class="confirm-btn">ปิด</button>
        </div>
    </div>
</div>

<!-- Status Update Modal -->
<div id="status-modal" class="modal-overlay" style="display: none;">
    <div class="modal-content">
        <div class="modal-header">
            <h2>อัปเดตสถานะ</h2>
        </div>
        <div class="modal-body">
            <div class="status-options">
                <label class="radio-option">
                    <input type="radio" name="status" value="รอตรวจ" <%=(patient.process==='รอตรวจ' || !patient.process)
                        ? 'checked' : '' %>>
                    <span class="radio-label">รอตรวจ</span>
                </label>
                <label class="radio-option">
                    <input type="radio" name="status" value="นัดหมาย" <%=patient.process==='นัดหมาย' ? 'checked' : ''
                        %>>
                    <span class="radio-label">นัดหมาย</span>
                </label>
                <label class="radio-option">
                    <input type="radio" name="status" value="เจาะเลือด" <%=patient.process==='เจาะเลือด' ? 'checked'
                        : '' %>>
                    <span class="radio-label">เจาะเลือด</span>
                </label>
                <label class="radio-option">
                    <input type="radio" name="status" value="กำลังจัดส่ง" <%=patient.process==='กำลังจัดส่ง' ? 'checked'
                        : '' %>>
                    <span class="radio-label">กำลังจัดส่ง</span>
                </label>
                <label class="radio-option">
                    <input type="radio" name="status" value="กำลังตรวจ" <%=patient.process==='กำลังตรวจ' ? 'checked'
                        : '' %>>
                    <span class="radio-label">กำลังตรวจ</span>
                </label>
                <label class="radio-option">
                    <input type="radio" name="status" value="เสร็จสิ้น" <%=patient.process==='เสร็จสิ้น' ? 'checked'
                        : '' %>>
                    <span class="radio-label">เสร็จสิ้น</span>
                </label>
            </div>

            <!-- Appointment DateTime Picker (Revamped) -->
            <div class="appointment-datetime-section" id="appointmentDatetimeSection"
                style="display: none; margin-top: 20px; padding: 20px; background: #F8FAFC; border: 1px solid #E2E8F0; border-radius: 12px;">
                <label
                    style="font-family: 'Kanit', sans-serif; font-weight: 500; font-size: 16px; color: #0F172A; display: flex; align-items: center; gap: 8px; margin-bottom: 16px;">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#6366F1" stroke-width="2"
                        stroke-linecap="round" stroke-linejoin="round">
                        <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
                        <line x1="16" y1="2" x2="16" y2="6"></line>
                        <line x1="8" y1="2" x2="8" y2="6"></line>
                        <line x1="3" y1="10" x2="21" y2="10"></line>
                    </svg>
                    กำหนดวันเวลานัดหมาย
                </label>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                    <div class="input-group">
                        <label
                            style="font-size: 13px; color: #64748B; margin-bottom: 6px; display: block;">วันที่</label>
                        <input type="date" id="appointmentDate"
                            style="width: 100%; padding: 10px 12px; border: 1px solid #CBD5E1; border-radius: 8px; font-size: 14px; font-family: 'Inter', sans-serif; outline: none; transition: border-color 0.2s;">
                    </div>
                    <div class="input-group">
                        <label style="font-size: 13px; color: #64748B; margin-bottom: 6px; display: block;">เวลา</label>
                        <input type="time" id="appointmentTime"
                            style="width: 100%; padding: 10px 12px; border: 1px solid #CBD5E1; border-radius: 8px; font-size: 14px; font-family: 'Inter', sans-serif; outline: none; transition: border-color 0.2s;">
                    </div>
                </div>
            </div>

            <div class="note-section">
                <label for="status-note">หมายเหตุ</label>
                <textarea id="status-note" rows="3" placeholder="ระบุหมายเหตุ..."></textarea>
            </div>
        </div>
        <div class="modal-footer">
            <button id="cancel-status-btn" class="cancel-btn">ยกเลิก</button>
            <button id="confirm-status-btn" class="confirm-btn">ยืนยัน</button>
        </div>
    </div>
</div>